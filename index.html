<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Backtest Forex</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#00ff99">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Backtest Forex\",
    \"short_name\": \"Backtest\",
    \"start_url\": \".\",
    \"display\": \"standalone\",
    \"background_color\": \"#111\",
    \"theme_color\": \"#00ff99\",
    \"icons\": [
      {\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EChart%3C/text%3E%3C/svg%3E\", \"sizes\": \"192x192\", \"type\": \"image/svg+xml\"}
    ]
  }">

  <!-- Apple Splash -->
  <link rel="apple-touch-startup-image" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23111'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='14' fill='%2300ff99' text-anchor='middle'%3EDASHBOARD%3C/text%3E%3C/svg%3E">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #111;
      --bg-panel: #222;
      --bg-deep: #1b1b1b;
      --accent: #00ff99;
      --accent-light: #00b33c;
      --text: #eee;
      --profit: #00ff66;
      --loss: #ff3333;
      --border: #444;
      --shadow: rgba(0,255,100,0.06);
    }

    [data-theme="light"] {
      --bg-dark: #f8f9fa;
      --bg-panel: #ffffff;
      --bg-deep: #f1f3f5;
      --accent: #00cc66;
      --accent-light: #00b33c;
      --text: #222;
      --profit: #00b33c;
      --loss: #cc0000;
      --border: #ddd;
      --shadow: rgba(0,204,102,0.1);
    }

    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      transition: 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Loading Screen */
    #loading {
      position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--accent);
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: var(--accent); font-weight: 700; font-size: 1.1rem; }

    /* Main Title */
    .main-title {
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
      font-size: 2.2rem;
      letter-spacing: 2px;
      margin: 16px 0 8px;
      background: linear-gradient(90deg, #00ff99, #00cc66);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from { text-shadow: 0 0 10px rgba(0,255,150,0.3); }
      to { text-shadow: 0 0 20px rgba(0,255,150,0.5); }
    }

    /* Header */
    header {
      background: var(--bg-panel);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
    }
    .header-content {
      display: flex; justify-content: space-between; align-items: center;
    }

    /* Tabs */
    .tabs {
      display: flex; gap: 8px; flex: 1; justify-content: center;
    }
    .tabs button {
      flex: 1; padding: 10px; border-radius: 8px; border: none;
      background: transparent; color: var(--text); font-weight: 500;
      transition: 0.2s; font-size: 0.9rem;
    }
    .tabs button.active {
      background: var(--accent-light); color: #000; font-weight: 700;
    }

    /* Theme Toggle */
    .theme-toggle {
      background: var(--bg-deep); border: 1px solid var(--border);
      color: var(--text); padding: 6px 10px; border-radius: 6px;
      font-size: 0.85rem;
    }

    /* Main */
    main {
      flex: 1; padding: 16px; max-width: 100%; overflow-x: hidden;
    }

    /* Cards */
    .card {
      background: var(--bg-panel); border-radius: 12px; padding: 16px;
      margin-bottom: 16px; box-shadow: 0 2px 8px var(--shadow);
    }

    /* Form */
    .form-group { margin-bottom: 14px; }
    label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 500; }
    input, select, textarea {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg-deep); color: var(--text); font-size: 0.95rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,255,150,0.2);
    }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button.primary {
      background: var(--accent-light); color: #000; border: none; padding: 12px;
      border-radius: 8px; font-weight: 700; width: 100%; margin-top: 8px;
    }

    /* Stats */
    .stats-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 16px 0;
    }
    .stat-box {
      background: var(--bg-deep); padding: 12px; border-radius: 8px; text-align: center;
      font-size: 0.9rem;
    }
    .stat-value { font-weight: 700; color: var(--accent); font-size: 1.1rem; }

    /* Table */
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { padding: 8px; text-align: center; border-bottom: 1px solid var(--border); }
    th { background: var(--accent-light); color: #000; font-weight: 700; }
    tr:nth-child(even) td { background: var(--bg-deep); }

    /* Filter */
    .filter-bar {
      display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;
    }
    .filter-bar select, .filter-bar input {
      flex: 1; min-width: 100px; font-size: 0.85rem;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bg-panel); border-top: 1px solid var(--border);
      display: flex; padding: 8px; gap: 8px; z-index: 100;
    }
    .bottom-nav button {
      flex: 1; padding: 12px; border-radius: 8px; border: none;
      background: var(--bg-deep); color: var(--text); font-size: 0.8rem;
    }

    /* Skeleton */
    .skeleton { background: #333; border-radius: 8px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* Responsive */
    @media (min-width: 768px) {
      .main-title { font-size: 2.8rem; }
      main { padding: 24px; max-width: 800px; margin: 0 auto; }
      .bottom-nav { display: none; }
      header { padding: 16px; }
    }
  </style>
</head>
<body data-theme="dark">

  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Memuat Dashboard...</div>
  </div>

  <!-- Main Title -->
  <h1 class="main-title">DASHBOARD BACKTEST FOREX</h1>

  <header>
    <div class="header-content">
      <div class="tabs">
        <button id="tabJurnal" class="active">Jurnal</button>
        <button id="tabNotulen">Notulen</button>
      </div>
      <button id="themeToggle" class="theme-toggle">Light</button>
    </div>
  </header>

  <main>
    <!-- JURNAL -->
    <section id="sectionJurnal" class="section active">
      <div class="card">
        <h3 style="color:var(--accent);margin-bottom:12px;">Modal & Risiko</h3>
        <div class="form-group">
          <input type="number" id="modalAwal" placeholder="Modal awal ($)" step="0.01">
        </div>
        <div class="form-group">
          <select id="riskSelect">
            <option value="1">1%</option>
            <option value="2">2%</option>
            <option value="3">3%</option>
            <option value="5">5%</option>
          </select>
        </div>
        <div class="stats-grid">
          <div class="stat-box">Risk: $<span id="riskValue">0.00</span></div>
          <div class="stat-box">Balance: $<span id="balanceDisplay">0.00</span></div>
        </div>
      </div>

      <div class="filter-bar">
        <select id="filterPair"><option value="">Semua Pair</option></select>
        <select id="filterStrategy"><option value="">Semua Strategi</option></select>
      </div>

      <div class="card win-rate" style="text-align:center;font-weight:700;">
        Win Rate: <span id="winRateValue">0%</span> (<span id="winCount">0</span>/<span id="totalTrades">0</span>)
      </div>

      <form id="jurnalForm" class="card">
        <div class="form-group"><input type="date" id="date" required></div>
        <div class="form-group">
          <select id="pair" required>
            <option value="">Pilih Pair</option>
            <option>EUR/USD</option><option>GBP/USD</option><option>USD/JPY</option>
            <option>AUD/USD</option><option>USD/CAD</option><option>USD/CHF</option><option>NZD/USD</option>
          </select>
        </div>
        <div class="form-group"><input type="text" id="strategy" placeholder="Strategi" required></div>
        <div class="grid-2">
          <div class="form-group"><input type="number" id="entry" step="0.0001" placeholder="Entry" required></div>
          <div class="form-group"><input type="number" id="exit" step="0.0001" placeholder="Exit" required></div>
        </div>
        <div class="form-group">
          <select id="resultType" required>
            <option value="">Hasil</option>
            <option>Profit</option><option>Loss</option>
          </select>
        </div>
        <div class="form-group"><input type="number" id="amount" step="0.01" placeholder="Jumlah ($)" required></div>
        <div class="form-group"><textarea id="notes" rows="2" placeholder="Catatan"></textarea></div>
        <div class="form-group"><input type="file" id="screenshot" accept="image/*"></div>
        <button type="submit" class="primary">Simpan</button>
      </form>

      <canvas id="profitChart" height="200"></canvas>

      <div class="card">
        <h3 style="color:var(--accent);margin-bottom:8px;">Riwayat</h3>
        <table id="historyTable">
          <thead><tr><th>Tgl</th><th>Pair</th><th>Hasil</th><th>$</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="stats-grid">
        <div class="stat-box profit">Profit: $<span id="totalProfit">0</span></div>
        <div class="stat-box loss">Loss: $<span id="totalLoss">0</span></div>
      </div>
    </section>

    <!-- NOTULEN -->
    <section id="sectionNotulen" class="section">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 style="color:var(--accent);margin:0;">Notulen</h3>
          <button id="saveNotulenBtn" class="add-btn" style="font-size:0.8rem;padding:6px 10px;">Simpan</button>
        </div>
        <textarea id="notulenArea" placeholder="Tulis catatan..."></textarea>
      </div>

      <div class="card">
        <h3 style="color:var(--accent);margin-bottom:8px;">Ceklis</h3>
        <div id="checklistContainer"></div>
        <button id="addChecklistBtn" class="add-btn" style="width:100%;margin-top:8px;">+ Item</button>
      </div>
    </section>
  </main>

  <!-- Bottom Nav (Mobile) -->
  <div class="bottom-nav">
    <button id="exportExcel">Excel</button>
    <button id="exportPDF">PDF</button>
    <button id="clearAll" style="background:#ff6666;color:#fff;">Reset</button>
  </div>

  <!-- Modal -->
  <div id="imgModal" class="modal">
    <div class="box">
      <button id="closeModal" style="position:absolute;top:10px;right:10px;background:none;border:none;color:var(--accent);font-size:1.5rem;">x</button>
      <img id="modalImg" src="" alt="Screenshot">
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Loading
    const loading = document.getElementById('loading');
    window.addEventListener('load', () => {
      setTimeout(() => { loading.style.opacity = '0'; setTimeout(() => loading.remove(), 500); }, 800);
    });

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:application/javascript,console.log("SW registered");');
    }

    // Theme
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const saved = localStorage.getItem('theme') || 'dark';
    body.setAttribute('data-theme', saved);
    themeToggle.textContent = saved === 'dark' ? 'Light' : 'Dark';
    themeToggle.onclick = () => {
      const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeToggle.textContent = newTheme === 'dark' ? 'Light' : 'Dark';
    };

    // Tabs
    const showSection = (id) => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
      document.querySelector(`[onclick="showSection('${id}')"]`)?.classList.add('active');
    };
    document.getElementById('tabJurnal').onclick = () => showSection('sectionJurnal');
    document.getElementById('tabNotulen').onclick = () => showSection('sectionNotulen');

    // Chart
    const ctx = document.getElementById('profitChart').getContext('2d');
    const chart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'Saldo', data: [], borderColor: '#00ff66', tension: 0.3 }] }, options: { responsive: true, scales: { y: { beginAtZero: false } } } });

    // Vars
    let modalAwal = 0, totalProfit = 0, totalLoss = 0, winCount = 0, totalTrades = 0;
    const tbody = document.querySelector('#historyTable tbody');

    // Load & Save
    const load = () => {
      modalAwal = parseFloat(localStorage.getItem('modalAwal') || '0');
      document.getElementById('modalAwal').value = modalAwal;
      const stats = JSON.parse(localStorage.getItem('stats') || '{}');
      totalProfit = stats.totalProfit || 0; totalLoss = stats.totalLoss || 0;
      winCount = stats.winCount || 0; totalTrades = stats.totalTrades || 0;
      document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
      document.getElementById('totalLoss').textContent = totalLoss.toFixed(2);
      updateWinRate(); updateBalance();
      tbody.innerHTML = localStorage.getItem('jurnalData') || '';
      const cd = JSON.parse(localStorage.getItem('chartData') || '{}');
      chart.data.labels = cd.labels || []; chart.data.datasets[0].data = cd.datasets[0].data || [];
      chart.update();
    };
    const save = () => {
      localStorage.setItem('modalAwal', modalAwal);
      localStorage.setItem('stats', JSON.stringify({ totalProfit, totalLoss, winCount, totalTrades }));
      localStorage.setItem('jurnalData', tbody.innerHTML);
      localStorage.setItem('chartData', JSON.stringify(chart.data));
    };

    // Update
    const updateBalance = () => {
      const pl = totalProfit - totalLoss;
      document.getElementById('balanceDisplay').textContent = (modalAwal + pl).toFixed(2);
      const risk = parseFloat(document.getElementById('riskSelect').value);
      document.getElementById('riskValue').textContent = modalAwal > 0 ? ((modalAwal * risk)/100).toFixed(2) : '0.00';
    };
    const updateWinRate = () => {
      const rate = totalTrades > 0 ? (winCount / totalTrades * 100).toFixed(1) : 0;
      document.getElementById('winRateValue').textContent = rate + '%';
      document.getElementById('winCount').textContent = winCount;
      document.getElementById('totalTrades').textContent = totalTrades;
    };

    // Form Submit
    document.getElementById('jurnalForm').onsubmit = e => {
      e.preventDefault();
      const data = {
        date: document.getElementById('date').value,
        pair: document.getElementById('pair').value,
        strategy: document.getElementById('strategy').value,
        entry: document.getElementById('entry').value,
        exit: document.getElementById('exit').value,
        result: document.getElementById('resultType').value,
        amount: parseFloat(document.getElementById('amount').value),
        notes: document.getElementById('notes').value
      };
      const pl = data.result === 'Profit' ? data.amount : -data.amount;
      const last = chart.data.datasets[0].data.slice(-1)[0] || modalAwal;
      chart.data.labels.push(data.date); chart.data.datasets[0].data.push(last + pl); chart.update();
      if (data.result === 'Profit') { totalProfit += data.amount; winCount++; } else totalLoss += data.amount;
      totalTrades++; updateWinRate(); updateBalance(); save();
      const row = document.createElement('tr');
      row.innerHTML = `<td>${data.date.slice(5)}</td><td>${data.pair}</td><td class="${data.result === 'Profit' ? 'profit' : 'loss'}">${data.result}</td><td class="${data.result === 'Profit' ? 'profit' : 'loss'}">${pl.toFixed(2)}</td>`;
      tbody.appendChild(row);
      e.target.reset();
    };

    // Export & Clear
    document.getElementById('exportExcel').onclick = () => {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(document.getElementById('historyTable'));
      XLSX.utils.book_append_sheet(wb, ws, 'Jurnal');
      XLSX.writeFile(wb, 'backtest.xlsx');
    };
    document.getElementById('clearAll').onclick = () => {
      if (confirm('Hapus semua?')) { localStorage.clear(); location.reload(); }
    };

    // Init
    load();
    document.getElementById('modalAwal').oninput = () => { modalAwal = parseFloat(this.value) || 0; updateBalance(); save(); };
    document.getElementById('riskSelect').onchange = updateBalance;
  </script>
</body>
</html>
